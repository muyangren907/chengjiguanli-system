
{extend name=".././view/list.html" /}
{block name="jsset"}

{/block}
{block name="nav"}
	<span class="layui-breadcrumb">
		<a href="">考试管理</a>
    <a href="">更多操作</a>
    <a href="">成绩查看</a>
		<a><cite>成绩列表</cite></a>
	</span>
{/block}
{block name="search"}

		<div class="layui-form-item">
          <label for="searchval" class="layui-form-label">
              关键字
          </label>
          <div class="layui-input-block">
              <input type="text" id="searchval" name="searchval"
              autocomplete="off" class="layui-input" placeholder="姓名、考号" placeholder="输入关键字并回车">
          </div>
        </div>
        <div class="layui-form-item">
		    <label for="school_id" class="layui-form-label" style="height: 100%">学校</label>
		    <div class="layui-input-block">
		    	{volist name="list.set.school_id" id="vo"}
		    		<input type="radio" name="school_id" title="{$vo.jiancheng}" value="{$vo.id}" lay-skin="primary"
            {eq name="key" value="0"} checked=true {/eq} >
		    	{/volist}
		    </div>
		</div>
		<div class="layui-form-item">
		    <label for="ruxuenian" class="layui-form-label" style="height: 100%">年级 </label>
		    <div class="layui-input-block">
		    	{foreach $list.set.nianji as $key=>$vo}
            <input type="radio" name="ruxuenian" value="{$vo.ruxuenian}" title="{$vo.nianjiname}" {eq name="key" value="0"} checked=true {/eq} >
		    	{/foreach}

		    </div>
		</div>
		<div class="layui-form-item" style="margin-bottom: 0;">
		    <label for="banji_id" class="layui-form-label" style="height: 100%">班级</label>
		    <div class="layui-input-block" id="banji_id" name="banji_id">
		    </div>
		</div>
		<input type="hidden" id="kaoshi_id" name="kaoshi_id" value="{$list.kaoshi_id}">

{/block}
{block name="table"}
	<table id="tabledemo" lay-filter="mytable" lay-size="sm"></table>
{/block}
{block name="myjs"}
<!-- 表格上面按钮模板 -->
<script type="text/html" id="toolbarDemo">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-danger" lay-event="dels">
      <i class="iconfont">&#xe69d;</i> 批量删除考号
    </button>
    <button class="layui-btn" lay-event="add">
      <i class="iconfont">&#xe6b9;</i> 添加考号
    </button>
    <button class="layui-btn" lay-event="delcj">
      <i class="iconfont">&#xe69d;</i> 删除成绩
    </button>
    <button class="layui-btn" lay-event="download">
      <i class="layui-icon layui-icon-download-circle"></i> 下载成绩列表
    </button>
    <button class="layui-btn" lay-event="downloadcjtiao">
      <i class="layui-icon layui-icon-download-circle"></i> 下载成绩条
    </button>
  </div>
</script>
<!-- 记录操作按钮模板 -->
<script type="text/html" id="barDemo">
  <a class="layui-btn-xs" lay-event="detail" title="录入信息"><i class="layui-icon layui-icon-search"></i></a>
  <a class="layui-btn-xs" lay-event="chengji" title="成绩图表"><i class="layui-icon layui-icon-chart-screen"></i></a>
  <a class="layui-btn-xs" lay-event="del" title="删除考号"><i class="layui-icon">&#xe640;</i></a>
</script>
<!-- 表格操作 -->
<script>
	// 设置列
	options.cols=[[ //表头
		{type:'checkbox', fixed: 'left'},
		{field: 'school_jiancheng', title: '学校', minWidth:100,sort: true},
		// {field: 'nianji', title: '年级 ', minWidth:100,sort: true},
		{field: "ban_title",title: '班级', minWidth:120,sort: true},
		{field: "student_xingming", title: '学生姓名',sort: true, minWidth:100},
	]];


	var xk = '<?php echo json_encode($list["set"]["subject_id"]);?>';
	xk = eval(decodeURIComponent(xk));
  var tjxm = '<?php echo json_encode($list["tjxm"]);?>';
  tjxm = eval(decodeURIComponent(tjxm));

  $.each(xk,function(index,value){
    options.cols[0].push({field: value.lieming, title: value.title , minWidth:120,sort: true,edit:'text',templet:function(d){
            var str = d[value.lieming].defen;
            if(str == null)
            {
              str = '';
            }
          return str;
        }});
    $.each(tjxm, function(t, val){
      options.cols[0].push({field: val.biaoshi, title: value.title + val.title , minWidth:120,templet:function(d){
            var str = d[value.lieming][val.biaoshi];
            if(str == null)
            {
              str = '';
            }
          return str;
        }});
    })

  });


  options.cols[0].push({field: 'avg', title: '平均分', minWidth:100,sort: true});
  options.cols[0].push({field: 'sum', title: '总分', minWidth:100,sort: true});
  options.cols[0].push({field: 'id', title: '操作',toolbar: '#barDemo',minWidth:125});

	// // 设置查询条件
 //  formval =
	// options.where = {
	// 	kaoshi:"{$list.kaoshi_id}"
 //    ,school:$("input[name='school']:checked").val()
 //    ,ruxuenian:$("input[name='ruxuenian']:checked").val()
	// }

	// 设置每页显示条数
	options.limit = 10;
	options.limits = [10,15];

	// 提交搜索条件后重载表格
    layui.use(['table','cjgl'],function(){
      var table = layui.table
      		cjgl = layui.cjgl;

      addBanji();

      //表头工具栏事件
      table.on('toolbar(mytable)', function(obj){
      	switch(obj.event){
      		case 'add':
            cjgl.add('添加考号','/kaohao/index/create/{$list.kaoshi_id}','650','400');
            break;
          case 'dels':
	      		var checkStatus = table.checkStatus('mytable'); //idmytable 即为基础参数 id 对应的值
	      		cjgl.delAll(checkStatus,'/kaohao/index/delete','mytable');
      			break;
      		case 'download':
      			cjgl.add('下载成绩列表','/chengji/index/dwchengji/{$list.kaoshi_id}','650','300');
      			break;
          case 'downloadcjtiao':
            cjgl.add('下载成绩条','/chengji/index/dwchengjitiao/{$list.kaoshi_id}','650','300');
            break;
          case 'delcj':
            parent.xadmin.add_tab('删除成绩','/chengji/index/deletecjs/{$list.kaoshi_id}',true);
            break;
      	};
      });

      //监听行工具条
      table.on('tool(mytable)', function(obj){
      	var data = obj.data; //获得当前行数据
      	var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
      	var tr = obj.tr; //获得当前行 tr 的DOM对象
      	switch(layEvent){
      		case 'detail':// 查看
            cjgl.add(obj.data.student_xingming + ' 成绩录入信息','/chengji/index/readcjadd/' + obj.data.id, '', '', true);
            break;
          case 'chengji':// 查看
            cjgl.add(obj.data.student_xingming + ' 成绩图表','/kaohao/index/read/' + obj.data.id, '', '', true);
            break;
      		case 'del':// 删除
	      		cjgl.del(obj,"/kaohao/index/delete");
	      		break;
      	};
      });

      // 单元格编辑
      table.on('edit(mytable)',function(obj){
      	// 声明变量
      	var newdefen = obj.value
      		,colname = obj.field
      		,rowdata = obj.data;

      	// 修改服务器数据
        $.ajax({
          url:"/luru/index/update/"+rowdata.id,
          type:'PUT',
          data:{
              "colname":colname,
              "newdefen":newdefen
          },
          success:function(result,obj){
              if(result.val == 0 || result.code==0)
              {
                layer.msg(result.msg,{icon:5});
              }else{
              	// 这个地方重新赋值平均分和总分
              }
          },
          error:function(result){
              layer.msg('数据扔半道啦。',function(){});
          },
        });
      });

      // 监听表单提交
      form.on('radio', function(data){
        addBanji();
        $("#srcsubmit").click();
      });

      // 添加班级列表
      function addBanji(){
        // 获取参数
        var formval = form.val('search');
        cjgl.createCheckbox('banji_id', formval, '/tools/kscy/class', 'banji_id', 'banTitle');
      }
    });
</script>
{/block}
