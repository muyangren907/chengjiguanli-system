{extend name=".././view/create.html" /}

{block name="jscss"}
  <style>
    .dh {
      min-height:50px;
      size:24px;
      padding-top:10px;
      text-align:center;
      min-height: 30px;
      float: left;
      margin-right: 1px;
    }
    .wancheng {
      border-bottom: 3px solid #01AAED;
    }

    .jinxing {
      border-bottom: 3px solid #FF5722;
    }

    .weicaozuo {
      border-bottom: 3px solid #FFB800;
    }
  </style>
{/block}

{block name="form"}
<div class="layui-form-item">
  <div class="dh wancheng" style="width: 10%;">开始</div>
  <div class="dh wancheng" style="width: 20%;">考试信息</div>
  <div class="dh wancheng" style="width: 20%;">各年级参加考试学科和分数线</div>
  <div class="dh jinxing" style="width: 20%;">生成参加考试学生名单</div>
  <div class="dh weicaozuo" style="width: 20%;">分配录入成绩任务</div>
  <div class="dh weicaozuo" style="width: 9%;">完成</div>
</div>
<form class="layui-form layui-form-pane" lay-filter="myform">
  <div class="layui-form-item">
    <label for="school_id" class="layui-form-label"><span class="x-red">*</span>参考学校</label>
    <div class="layui-input-block">
      {php}$schoolList = danweiJibie('校级', '校级');{/php}
      <select name="school_id" id="school_id" lay-filter="school_id" lay-verify="required">
        <option value="">请选择学校</option>
        {foreach $schoolList as $key=>$vo }
        <option value="{$vo.id}">
        {$vo.title}
      </option>
      {/foreach}
    </select>
  </div>
</div>
<div class="layui-form-item">
  {foreach $list.data.nianji as $key=>$vo }
  <label for="title" class="layui-form-label" title="nianji">{$vo.nianjiname}</label>
  <div class="layui-input-block" id="{$vo.ruxuenian}">
   <input type="checkbox" title="全选" lay-skin="primary"  checkall="p">
 </div>
 {/foreach}
</div>
<input type="hidden" name="kaoshi_id" id="kaoshi_id" value="{$list.set.kaoshi_id}">
<div class="layui-form-item" style="text-align: right;">
  <a href="javascript:;" onclick="preSet()" class="layui-btn layui-btn-danger" style="margin-left: 10px;">上一步</a>
  <button  class="layui-btn" lay-filter="kssubmit" lay-submit=""> 
    {$list.set.butname}
  </button>
  <a href="javascript:;" onclick="nextSet()" class="layui-btn layui-btn-danger" style="margin-left: 10px;">下一步</a>
</div>
</form>
{/block}

{block name="myjs"}
<script>
  layui.use('form', function(){
    var form = layui.form;
    form.on('select(school_id)', function(data){
    // 声明变量
    var school_id = data.value;
    var nianji = "<?php echo json_encode($list['data']['nianjiNum']);?>";
      // 获取数据
      $.post(
        "/teach/banji/mybanjis",
        {
          "school_id":school_id
          ,"ruxuenian":eval(nianji)
        },
        function(data,status){
          $('input[title="全选"]').each(function(){
            $(this).nextAll().remove();
          });
          $('input[title="全选"]').prop('checked',false);
          if($.isEmptyObject(data))
          {
            return true;
          }
          for (var i in data) {
                  // $('#'+data[i]['ruxuenian']).nextAll().remove();
                  for(x in data[i]['njBanji']){
                    $('#'+data[i]['ruxuenian']).append('<input type="checkbox" name="banji_id[]" value="'+data[i]['njBanji'][x]['id']+'" title="'+data[i]['njBanji'][x]['banTitle']+'" lay-skin="primary" checkall="c">');
                  }
                }
                form.render('checkbox');
              }
              );
    });


    //监听提交
    form.on('submit(kssubmit)', function(data){
      $.ajax({
        url:"{$list.set.url}",
        type:"{$list.set.formpost}",
        data:data.field,
        dataType:'json',
        success:function(result){
          if(result.val == 1)
          {
            // $(location).attr('href', '/kaoshi/kaoshiset/create/' + "{$list['set']['kaoshi_id']}");
            parent.layer.msg(result.msg);
          }else{
            layer.msg(result.msg);
          }
        },
        error:function(xhr,status,error) {
          layer.msg('数据处理错误',{
              icon: 2,
              time: 2000 //2秒关闭（如果不配置，默认是3秒）
          });
        }
      });
      return false;
    });
});

  function nextSet()
  {
    $(location).attr('href', '/kaoshi/index/setp4/' + "{$list['set']['kaoshi_id']}");
    return false;
  }


  function preSet()
  {
    $(location).attr('href', '/kaoshi/index/setp2/' + "{$list['set']['kaoshi_id']}");
    return false;
  }

</script>
{/block}

